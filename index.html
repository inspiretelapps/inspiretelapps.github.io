<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeastar P-Series Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <!-- PWA Manifest and Theme Color -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/3498db/FFFFFF?text=PBX">
</head>
<body>

    <div class="container">
        <header>
            <h1>Yeastar Dashboard</h1>
            <label class="flex cursor-pointer gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/></svg>
                <input type="checkbox" id="theme-toggle" class="toggle"/>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </label>
        </header>

        <!-- API Configuration -->
        <div id="api-config-section" class="card">
            <h2>API Configuration</h2>
            <div class="form-group">
                <label for="pbx-host">PBX Host URL</label>
                <input type="text" id="pbx-host" class="input" placeholder="pbx.yeastarcloud.com">
            </div>
            <div class="form-group">
                <label for="client-id">Client ID</label>
                <input type="text" id="client-id" class="input" placeholder="Your Client ID">
            </div>
            <div class="form-group">
                <label for="client-secret">Client Secret</label>
                <input type="password" id="client-secret" class="input" placeholder="Your Client Secret">
            </div>
            <button id="connect-btn" class="btn btn-primary">Connect & Fetch Data</button>
            <button id="save-config-btn" class="btn btn-secondary">Save Config</button>
            <div class="text-center mt-4">
                <a href="https://cors-anywhere.herokuapp.com/" target="_blank" class="link">Connection issues? Click here to activate the API proxy.</a>
            </div>
            <p style="font-size: 0.75rem; opacity: 0.7; margin-top: 1rem;">Note: If you encounter connection issues, ensure your current IP address is whitelisted in your Yeastar PBX's API settings (Integrations > API > IP Restriction).</p>
        </div>

        <div id="dashboard-content" class="hidden">
            <!-- Live Monitoring Section -->
            <div id="live-monitoring-section" class="card">
                <h2>Live Monitoring</h2>
                <div id="trunk-status-panel">
                    <h3>Trunk Status</h3>
                    <div id="trunk-status-loader">Loading...</div>
                    <div id="trunk-status-content" class="hidden"></div>
                </div>
                <div id="active-call-view" style="margin-top: 1.5rem;">
                    <h3>Active Calls</h3>
                    <div id="active-call-loader">Loading...</div>
                    <div id="active-call-content" class="hidden"></div>
                </div>
                <div id="live-agent-status" style="margin-top: 1.5rem;">
                    <h3>Live Agent Status</h3>
                    <div class="form-group">
                        <label for="queue-select">Select Queue</label>
                        <select id="queue-select" class="input"></select>
                    </div>
                    <div id="agent-status-loader">Loading...</div>
                    <div id="agent-status-content" class="hidden"></div>
                </div>
            </div>

            <!-- Today's Stats -->
            <div class="card">
                <h2>Today's Stats</h2>
                <div id="stats-loader">Loading...</div>
                <div id="stats-content" class="hidden">
                    <div id="overall-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center; margin-bottom: 1.5rem;">
                        <!-- Overall stats will be injected here -->
                    </div>
                    <div id="extension-stats">
                        <h3>Per Extension</h3>
                        <div style="overflow-x: auto;">
                            <table id="extension-stats-body">
                                <!-- Extension stats rows will be injected here -->
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Calls -->
            <div class="card">
                <h2>Recent Calls</h2>
                <div id="recent-calls-loader">Loading...</div>
                <div id="recent-calls-content" class="hidden">
                    <!-- Recent calls will be injected here -->
                </div>
            </div>

            <!-- Advanced Inbound Route Management -->
            <div class="card">
                <h2>Advanced Inbound Route Management</h2>
                <div id="routing-loader">Loading...</div>
                <div id="routing-content" class="hidden">
                    <!-- Inbound routes will be injected here -->
                </div>
            </div>
        </div>

        <!-- Edit Route Modal -->
        <dialog id="edit-route-modal" class="modal">
            <div class="modal-box">
                <h3 id="edit-route-modal-title">Edit Inbound Route</h3>
                <form id="edit-route-form">
                    <input type="hidden" id="edit-route-id">
                    <div class="form-group">
                        <label><input type="radio" name="routing-logic" value="simple" checked> Simple Destination</label>
                        <label><input type="radio" name="routing-logic" value="time-based"> Time-Based Routing</label>
                    </div>
                    <div id="simple-destination-section">
                        <div class="form-group">
                            <label for="simple-dest-select">Destination</label>
                            <select id="simple-dest-select" class="input"></select>
                        </div>
                    </div>
                    <div id="time-based-section" class="hidden">
                        <div class="form-group">
                            <label for="business-hours-dest-select">Business Hours Destination</label>
                            <select id="business-hours-dest-select" class="input"></select>
                        </div>
                        <div class="form-group">
                            <label for="outside-business-hours-dest-select">Outside Business Hours Destination</label>
                            <select id="outside-business-hours-dest-select" class="input"></select>
                        </div>
                         <div class="form-group">
                            <label for="holidays-dest-select">Holidays Destination</label>
                            <select id="holidays-dest-select" class="input"></select>
                        </div>
                    </div>
                    <div class="modal-action">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn" onclick="document.getElementById('edit-route-modal').close()">Cancel</button>
                    </div>
                </form>
            </div>
        </dialog>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- THEME CONTROLLER ---
            const themeToggle = document.getElementById('theme-toggle');
            const htmlElement = document.documentElement;

            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDark) {
                htmlElement.classList.add('dark-mode');
                themeToggle.checked = true;
            }

            themeToggle.addEventListener('change', () => {
                htmlElement.classList.toggle('dark-mode');
            });

            // DOM Elements
            const pbxHostInput = document.getElementById('pbx-host');
            const clientIdInput = document.getElementById('client-id');
            const clientSecretInput = document.getElementById('client-secret');
            const connectBtn = document.getElementById('connect-btn');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const apiConfigSection = document.getElementById('api-config-section');
            const dashboardContent = document.getElementById('dashboard-content');
            const queueSelect = document.getElementById('queue-select');

            // Load saved config
            const savedConfig = JSON.parse(localStorage.getItem('yeastarConfig'));
            if (savedConfig) {
                pbxHostInput.value = savedConfig.host;
                clientIdInput.value = savedConfig.clientId;
                clientSecretInput.value = savedConfig.clientSecret;
            }

            // Global state
            let accessToken = sessionStorage.getItem('yeastar_accessToken');
            let pbxHost = '';
            let extensionMap = new Map();
            
            const PROXY_URL = 'https://cors-anywhere.herokuapp.com/';

            // --- API HELPER ---
            async function apiRequest(endpoint, method = 'GET', body = null, isRetry = false) {
                if (!accessToken) {
                    if (isRetry) {
                        alert('Authentication failed. Please check your credentials and connect again.');
                        return null;
                    }
                    console.log("Access token missing, attempting to get a new one...");
                    const newAccessToken = await getAccessToken(pbxHostInput.value, clientIdInput.value, clientSecretInput.value);
                    if (newAccessToken) {
                        accessToken = newAccessToken;
                        return apiRequest(endpoint, method, body, true);
                    } else {
                        return null;
                    }
                }

                const url = new URL(`https://${pbxHost}/openapi/v1.0/${endpoint.split('?')[0]}`);
                const params = new URLSearchParams(endpoint.split('?')[1] || '');
                params.append('access_token', accessToken);
                url.search = params.toString();

                const proxiedUrl = PROXY_URL + url.toString();

                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'YeastarDashboardWebApp',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }

                try {
                    const response = await fetch(proxiedUrl, options);
                    const responseText = await response.text();
                    const responseData = JSON.parse(responseText);
                    
                    if (responseData.errcode === 10004 && !isRetry) { // Token expired
                        console.log("Token expired, refreshing...");
                        accessToken = null;
                        sessionStorage.removeItem('yeastar_accessToken');
                        return apiRequest(endpoint, method, body, true);
                    }

                    if (!response.ok || (responseData.errcode && responseData.errcode !== 0)) {
                        throw new Error(`API Error ${responseData.errcode}: ${responseData.errmsg}`);
                    }
                    return responseData;
                } catch (error) {
                    console.error(`Error in apiRequest for ${endpoint}:`, error);
                     if (error instanceof SyntaxError) {
                        alert('Failed to parse API response. This is likely a CORS proxy issue. Please click the "Activate API Proxy" link, request temporary access on that page, and then try connecting again.');
                    } else {
                        alert(`An error occurred while fetching data from ${endpoint}. ${error.message}`);
                    }
                    return null;
                }
            }
            
            // --- AUTHENTICATION ---
            async function getAccessToken(host, clientId, clientSecret) {
                const targetUrl = `https://${host}/openapi/v1.0/get_token`;
                const url = PROXY_URL + targetUrl;
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'User-Agent': 'YeastarDashboardWebApp',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            username: clientId,
                            password: clientSecret
                        })
                    });
                    
                    const responseText = await response.text();
                    const data = JSON.parse(responseText);

                    if (data.errcode === 0) {
                        sessionStorage.setItem('yeastar_accessToken', data.access_token);
                        return data.access_token;
                    } else {
                        throw new Error(`Error ${data.errcode}: ${data.errmsg}`);
                    }
                } catch (error) {
                    console.error('Error getting access token:', error);
                    if (error instanceof SyntaxError) {
                        alert('Failed to parse API response. This is likely a CORS proxy issue. Please click the "Activate API Proxy" link, request temporary access on that page, and then try connecting again.');
                    } else {
                        alert(`Failed to get access token: ${error.message}. Please check your credentials and PBX Host URL.`);
                    }
                    return null;
                }
            }


            // --- DATA FETCHING AND RENDERING ---

            // 0. Live Agent Status
            async function fetchAndPopulateQueues() {
                const result = await apiRequest('queue/list');
                if (result && result.errcode === 0 && result.data) {
                    queueSelect.innerHTML = '<option disabled selected>Choose a queue</option>';
                    result.data.forEach(queue => {
                        const option = document.createElement('option');
                        option.value = queue.id;
                        option.textContent = `${queue.name} (${queue.number})`;
                        queueSelect.appendChild(option);
                    });
                }
            }

            async function fetchAndRenderAgentStatus(queueId) {
                setLoader('agent-status', true);
                const result = await apiRequest(`queue/agent_status?queue_id=${queueId}`);
                if (result && result.errcode === 0) {
                    renderAgentStatus(result.data);
                } else {
                    renderAgentStatus([]);
                }
                setLoader('agent-status', false);
            }

            function renderAgentStatus(agents) {
                const container = document.getElementById('agent-status-content');
                container.innerHTML = '';
                if (!agents || agents.length === 0) {
                    container.innerHTML = '<p>No agents found for this queue.</p>';
                    return;
                }

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Agent</th>
                            <th class="text-center">Login Status</th>
                            <th class="text-center">Pause Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;
                const tbody = table.querySelector('tbody');
                agents.forEach(agent => {
                    const row = `
                        <tr>
                            <td>${agent.name} (${agent.number})</td>
                            <td class="text-center"><span class="badge ${agent.is_login ? 'badge-success' : 'badge-ghost'}">${agent.is_login ? 'Logged In' : 'Logged Out'}</span></td>
                            <td class="text-center"><span class="badge ${agent.is_pause ? 'badge-warning' : 'badge-ghost'}">${agent.is_pause ? `Paused (${agent.pause_reason || 'N/A'})` : 'Not Paused'}</span></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                container.appendChild(table);
            }


            // 0. Active Calls
            async function fetchAndRenderActiveCalls() {
                setLoader('active-call', true);
                const result = await apiRequest('call/query');
                if (result && result.errcode === 0) {
                    renderActiveCalls(result.data);
                } else {
                    renderActiveCalls([]);
                }
                setLoader('active-call', false);
            }

            function renderActiveCalls(calls) {
                const container = document.getElementById('active-call-content');
                container.innerHTML = '';
                if (!calls || calls.length === 0) {
                    container.innerHTML = '<p>No active calls.</p>';
                    return;
                }

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>From</th>
                            <th>To</th>
                            <th>Duration</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;
                const tbody = table.querySelector('tbody');
                calls.forEach(call => {
                    const row = `
                        <tr>
                            <td>${call.caller_number}</td>
                            <td>${call.callee_number}</td>
                            <td>${formatDuration(call.duration)}</td>
                            <td class="text-center">
                                <button class="btn btn-error" data-channel-id="${call.channel_id}">Hang Up</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                container.appendChild(table);

                document.querySelectorAll('.btn-error').forEach(btn => {
                    btn.addEventListener('click', handleHangup);
                });
            }

            async function handleHangup(event) {
                const channelId = event.target.dataset.channelId;
                if (!channelId) {
                    alert('Error: Channel ID not found.');
                    return;
                }
                
                const confirmed = confirm('Are you sure you want to hang up this call?');
                if (confirmed) {
                    const result = await apiRequest('call/hangup', 'POST', { channel_id: channelId });
                    if (result && result.errcode === 0) {
                        alert('Call hung up successfully.');
                        fetchAndRenderActiveCalls(); // Refresh the list
                    } else {
                        alert('Failed to hang up call.');
                    }
                }
            }

            // 0. Trunk Status
            async function fetchAndRenderTrunkStatus() {
                setLoader('trunk-status', true);
                const result = await apiRequest('trunk/list');
                if (result && result.errcode === 0) {
                    renderTrunkStatus(result.data);
                } else {
                    renderTrunkStatus([]);
                }
                setLoader('trunk-status', false);
            }

            function renderTrunkStatus(trunks) {
                const container = document.getElementById('trunk-status-content');
                container.innerHTML = '';
                if (!trunks || trunks.length === 0) {
                    container.innerHTML = '<p>No trunks found.</p>';
                    return;
                }

                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;
                const tbody = table.querySelector('tbody');
                trunks.forEach(trunk => {
                    const row = `
                        <tr>
                            <td>${trunk.name}</td>
                            <td>${trunk.type}</td>
                            <td class="text-center"><span class="badge ${getTrunkStatusBadge(trunk.status)}">${formatTrunkStatus(trunk.status)}</span></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                container.appendChild(table);
            }


            async function fetchAllExtensions() {
                const result = await apiRequest('extension/list?page_size=1000');
                if (result && result.data) {
                    extensionMap.clear();
                    result.data.forEach(ext => {
                        extensionMap.set(ext.number, ext.id);
                    });
                    return result.data.map(ext => ext.id);
                }
                return [];
            }

            // 1. Today's Stats
            async function fetchAndRenderStats(extensionIds) {
                setLoader('stats', true);
                
                if (extensionIds.length === 0) {
                    console.log("No extensions found to fetch stats for.");
                    renderStats([]);
                    setLoader('stats', false);
                    return;
                }

                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');

                const startTime = `${year}/${month}/${day} 00:00:00`;
                const endTime = `${year}/${month}/${day} 23:59:59`;

                const endpoint = `call_report/list?type=extcallstatistics&start_time=${encodeURIComponent(startTime)}&end_time=${encodeURIComponent(endTime)}&ext_id_list=${extensionIds.join(',')}`;
                const result = await apiRequest(endpoint);

                if (result && result.errcode === 0 && result.ext_call_statistics_list) {
                    renderStats(result.ext_call_statistics_list);
                } else {
                    console.error("Failed to fetch stats or no stats available:", result);
                    renderStats([]);
                }
                setLoader('stats', false);
            }

            function renderStats(stats) {
                let totalAnswered = 0;
                let totalDuration = 0;
                let totalMissed = 0;
                
                const extensionStatsBody = document.getElementById('extension-stats-body');
                extensionStatsBody.innerHTML = '';

                if (!stats || stats.length === 0) {
                    const row = `
                        <tr>
                            <td colspan="3" class="text-center">No call statistics for today.</td>
                        </tr>
                    `;
                    extensionStatsBody.innerHTML = row;
                } else {
                    stats.forEach(ext => {
                        const inboundAnswered = ext.inbound_answered_calls || 0;
                        const outboundAnswered = ext.outbound_answered_calls || 0;
                        const row = `
                            <tr>
                                <td>${ext.ext_name} (${ext.ext_num})</td>
                                <td class="text-center">${inboundAnswered}/${outboundAnswered}</td>
                                <td class="text-center">${formatDuration(ext.total_talking_time)}</td>
                            </tr>
                        `;
                        extensionStatsBody.innerHTML += row;

                        totalAnswered += ext.answered_calls;
                        totalDuration += ext.total_talking_time;
                        totalMissed += ext.missed_calls || 0;
                    });
                }

                const overallStatsContainer = document.getElementById('overall-stats');
                overallStatsContainer.innerHTML = `
                    <div>
                        <div>Total Answered</div>
                        <div>${totalAnswered}</div>
                    </div>
                    <div>
                        <div>Total Missed</div>
                        <div style="color: var(--color-error);">${totalMissed}</div>
                    </div>
                    <div>
                        <div>Total Duration</div>
                        <div>${formatDuration(totalDuration)}</div>
                    </div>
                `;
            }

            // 2. Inbound Routing
            async function fetchAndRenderInboundRoutes() {
                setLoader('routing', true);
                const result = await apiRequest('inbound_route/list?page_size=100');
                if (result && result.errcode === 0) {
                    renderInboundRoutes(result.data);
                } else {
                     renderInboundRoutes([]);
                }
                setLoader('routing', false);
            }

            function renderInboundRoutes(routes) {
                const container = document.getElementById('routing-content');
                container.innerHTML = '';
                 if (!routes || routes.length === 0) {
                    container.innerHTML = '<p>No inbound routes found.</p>';
                    return;
                }
                routes.forEach(route => {
                    const routeElement = document.createElement('div');
                    routeElement.style.backgroundColor = 'var(--color-base-200)';
                    routeElement.style.padding = '1rem';
                    routeElement.style.borderRadius = 'var(--radius)';

                    let destinationHTML = '';
                    if (route.time_condition === 'disabled') {
                        destinationHTML = `<p>Default: <span>${route.default_desination_value || 'Not Set'}</span></p>`;
                    } else {
                         destinationHTML = `
                            <p>Office Hours: <span>${route.business_hours_destination_value || 'Not Set'}</span></p>
                            <p>Outside Office Hours: <span>${route.outside_business_hours_destination_value || 'Not Set'}</span></p>
                         `;
                    }

                    routeElement.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                            <div>
                                <h4>${route.name}</h4>
                                ${destinationHTML}
                            </div>
                            <button class="btn" data-route-id="${route.id}">Edit</button>
                        </div>
                    `;
                    container.appendChild(routeElement);
                });
                 
                document.querySelectorAll('[data-route-id]').forEach(btn => {
                    btn.addEventListener('click', handleEditRoute);
                });
            }
            
            async function handleEditRoute(event) {
                const routeId = event.target.dataset.routeId;
                const modal = document.getElementById('edit-route-modal');
                document.getElementById('edit-route-id').value = routeId;

                const routeDetails = await apiRequest(`inbound_route/get?id=${routeId}`);
                if (!routeDetails || routeDetails.errcode !== 0) {
                    alert('Failed to fetch route details.');
                    return;
                }

                const menuOptions = await apiRequest('system/get_menuoptions');
                if (!menuOptions || menuOptions.errcode !== 0) {
                    alert('Failed to fetch destination options.');
                    return;
                }
                
                populateDestinationSelects(menuOptions.data);

                const route = routeDetails.data;
                document.getElementById('edit-route-modal-title').textContent = `Edit: ${route.name}`;
                
                const simpleRadio = document.querySelector('input[name="routing-logic"][value="simple"]');
                const timeBasedRadio = document.querySelector('input[name="routing-logic"][value="time-based"]');

                if (route.time_condition === 'disabled') {
                    simpleRadio.checked = true;
                    document.getElementById('simple-destination-section').classList.remove('hidden');
                    document.getElementById('time-based-section').classList.add('hidden');
                    document.getElementById('simple-dest-select').value = `${route.def_dest}:${route.def_dest_value}`;
                } else {
                    timeBasedRadio.checked = true;
                    document.getElementById('simple-destination-section').classList.add('hidden');
                    document.getElementById('time-based-section').classList.remove('hidden');
                    document.getElementById('business-hours-dest-select').value = `${route.business_hours_destination}:${route.business_hours_destination_value}`;
                    document.getElementById('outside-business-hours-dest-select').value = `${route.outside_business_hours_destination}:${route.outside_business_hours_destination_value}`;
                    document.getElementById('holidays-dest-select').value = `${route.holidays_hours_destination}:${route.holidays_hours_destination_value}`;
                }

                modal.showModal();
            }

            function populateDestinationSelects(options) {
                const selects = [
                    document.getElementById('simple-dest-select'),
                    document.getElementById('business-hours-dest-select'),
                    document.getElementById('outside-business-hours-dest-select'),
                    document.getElementById('holidays-dest-select')
                ];

                selects.forEach(select => {
                    select.innerHTML = '<option value="none:">Not Set</option>';
                    options.extension.forEach(ext => select.innerHTML += `<option value="extension:${ext.id}">${ext.name} (Ext: ${ext.number})</option>`);
                    options.ivr.forEach(ivr => select.innerHTML += `<option value="ivr:${ivr.id}">IVR: ${ivr.name}</option>`);
                    options.queue.forEach(q => select.innerHTML += `<option value="queue:${q.id}">Queue: ${q.name}</option>`);
                });
            }

            document.getElementById('edit-route-form').addEventListener('submit', async (event) => {
                event.preventDefault();
                const routeId = document.getElementById('edit-route-id').value;
                const routingLogic = document.querySelector('input[name="routing-logic"]:checked').value;
                
                let payload = { id: parseInt(routeId) };

                if (routingLogic === 'simple') {
                    const [dest, destValue] = document.getElementById('simple-dest-select').value.split(':');
                    payload.time_condition = 'disabled';
                    payload.def_dest = dest;
                    payload.def_dest_value = destValue;
                } else {
                    const [bhDest, bhValue] = document.getElementById('business-hours-dest-select').value.split(':');
                    const [obhDest, obhValue] = document.getElementById('outside-business-hours-dest-select').value.split(':');
                    const [hDest, hValue] = document.getElementById('holidays-dest-select').value.split(':');

                    payload.time_condition = 'global';
                    payload.business_hours_destination = bhDest;
                    payload.business_hours_destination_value = bhValue;
                    payload.outside_business_hours_destination = obhDest;
                    payload.outside_business_hours_destination_value = obhValue;
                    payload.holidays_hours_destination = hDest;
                    payload.holidays_hours_destination_value = hValue;
                }

                const result = await apiRequest('inbound_route/update', 'POST', payload);
                if (result && result.errcode === 0) {
                    alert('Route updated successfully!');
                    document.getElementById('edit-route-modal').close();
                    fetchAndRenderInboundRoutes();
                } else {
                    alert(`Failed to update route. Error: ${result ? result.errmsg : 'Unknown'}`);
                }
            });

            document.querySelectorAll('input[name="routing-logic"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'simple') {
                        document.getElementById('simple-destination-section').classList.remove('hidden');
                        document.getElementById('time-based-section').classList.add('hidden');
                    } else {
                        document.getElementById('simple-destination-section').classList.add('hidden');
                        document.getElementById('time-based-section').classList.remove('hidden');
                    }
                });
            });


            // 4. Recent Calls
            async function fetchAndRenderRecentCalls() {
                setLoader('recent-calls', true);
                const endpoint = `cdr/list?page_size=10&sort_by=time&order_by=desc`;
                const result = await apiRequest(endpoint);

                if (result && result.errcode === 0) {
                    renderRecentCalls(result.data);
                }
                setLoader('recent-calls', false);
            }

            function renderRecentCalls(calls) {
                const container = document.getElementById('recent-calls-content');
                container.innerHTML = '';
                if (calls.length === 0) {
                    container.innerHTML = '<p>No recent calls found.</p>';
                    return;
                }
                calls.forEach(call => {
                    const callElement = document.createElement('div');
                    callElement.style.backgroundColor = 'var(--color-base-200)';
                    callElement.style.padding = '0.75rem';
                    callElement.style.borderRadius = 'var(--radius)';
                    callElement.style.display = 'flex';
                    callElement.style.justifyContent = 'space-between';
                    callElement.style.alignItems = 'center';
                    callElement.innerHTML = `
                        <div>
                            <p>${call.call_from} -> ${call.call_to}</p>
                            <p style="font-size: 0.875rem; opacity: 0.7;">${call.time} - ${call.disposition} (${formatDuration(call.talk_duration)})</p>
                        </div>
                        <div>
                            <span class="badge ${getCallTypeBadge(call.call_type)}">${call.call_type}</span>
                        </div>
                    `;
                    container.appendChild(callElement);
                });
            }
            
            // --- UTILITY FUNCTIONS ---
            function formatTrunkStatus(status) {
                const statusMap = { 0: 'Idle', 1: 'Busy', 2: 'Ringing', 3: 'Dialing', 4: 'Unavailable', 5: 'Registering', 6: 'Registered', 7: 'Unregistered', 8: 'Failed', 9: 'Authenticating', 10: 'Connecting' };
                return statusMap[status] || 'Unknown';
            }

            function getTrunkStatusBadge(status) {
                 switch (status) {
                    case 6: return 'badge-success';
                    case 0: return 'badge-info';
                    case 1: return 'badge-warning';
                    case 8: return 'badge-error';
                    default: return 'badge-ghost';
                }
            }

            function setLoader(type, isLoading) {
                const loader = document.getElementById(`${type}-loader`);
                const content = document.getElementById(`${type}-content`);
                if (!loader || !content) return; 
                if (isLoading) {
                    loader.classList.remove('hidden');
                    content.classList.add('hidden');
                } else {
                    loader.classList.add('hidden');
                    content.classList.remove('hidden');
                }
            }

            function formatDuration(seconds) {
                if (seconds === null || seconds === undefined) return '0s';
                if (seconds < 60) return `${seconds}s`;
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}m ${remainingSeconds}s`;
            }

            function getCallTypeBadge(type) {
                if (!type) return 'badge-ghost';
                switch (type.toLowerCase()) {
                    case 'inbound': return 'badge-success';
                    case 'outbound': return 'badge-info';
                    case 'internal': return 'badge-warning';
                    default: return 'badge-ghost';
                }
            }

            // --- PWA Service Worker ---
            function registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    const swContent = `
                        const CACHE_NAME = 'yeastar-dashboard-cache-v2';
                        const urlsToCache = ['./index.html', './style.css'];
                        self.addEventListener('install', event => { event.waitUntil( caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)) ); });
                        self.addEventListener('activate', event => { const cacheWhitelist = [CACHE_NAME]; event.waitUntil( caches.keys().then(cacheNames => Promise.all( cacheNames.map(cacheName => { if (cacheWhitelist.indexOf(cacheName) === -1) { return caches.delete(cacheName); } }) )) ); });
                        self.addEventListener('fetch', event => { if (event.request.url.startsWith('http')) { event.respondWith( caches.open(CACHE_NAME).then(cache => cache.match(event.request).then(response => { const fetchPromise = fetch(event.request).then(networkResponse => { if (!event.request.url.includes('/openapi/v1.0/')) { cache.put(event.request, networkResponse.clone()); } return networkResponse; }); return response || fetchPromise; })) ); } });
                    `;
                    const blob = new Blob([swContent], {type: 'application/javascript'});
                    const swUrl = URL.createObjectURL(blob);
                    navigator.serviceWorker.register(swUrl).then(reg => console.log('SW reg success', reg)).catch(err => console.log('SW reg failed', err));
                }
            }

            function setupManifest() {
                 const manifest = {
                    "name": "Yeastar PBX Dashboard", "short_name": "PBX Dash", "start_url": ".", "display": "standalone", "background_color": "#ffffff", "theme_color": "#ffffff",
                    "icons": [ { "src": "https://placehold.co/192x192/3498db/FFFFFF?text=PBX", "sizes": "192x192", "type": "image/png" }, { "src": "https://placehold.co/512x512/3498db/FFFFFF?text=PBX", "sizes": "512x512", "type": "image/png" } ]
                };
                const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
                const manifestURL = URL.createObjectURL(blob);
                document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);
            }

            // --- INITIALIZATION ---
            setupManifest();
            registerServiceWorker();

            // --- EVENT LISTENERS ---
            connectBtn.addEventListener('click', async () => {
                pbxHost = pbxHostInput.value.trim();
                const clientId = clientIdInput.value.trim();
                const clientSecret = clientSecretInput.value.trim();

                if (!pbxHost || !clientId || !clientSecret) {
                    alert('Please fill in all API configuration fields.');
                    return;
                }
                
                sessionStorage.removeItem('yeastar_accessToken');
                accessToken = null;

                const initialAccessToken = await getAccessToken(pbxHost, clientId, clientSecret);
                if (initialAccessToken) {
                    accessToken = initialAccessToken;
                    apiConfigSection.classList.add('hidden');
                    dashboardContent.classList.remove('hidden');
                    
                    const extensionIds = await fetchAllExtensions();
                    
                    if(extensionIds) {
                        Promise.all([
                            fetchAndPopulateQueues(),
                            fetchAndRenderActiveCalls(),
                            fetchAndRenderTrunkStatus(),
                            fetchAndRenderStats(extensionIds),
                            fetchAndRenderInboundRoutes(),
                            fetchAndRenderRecentCalls()
                        ]);
                    }
                }
            });

            queueSelect.addEventListener('change', (event) => {
                const queueId = event.target.value;
                if (queueId) {
                    fetchAndRenderAgentStatus(queueId);
                }
            });
            
            saveConfigBtn.addEventListener('click', () => {
                const config = {
                    host: pbxHostInput.value.trim(),
                    clientId: clientIdInput.value.trim(),
                    clientSecret: clientSecretInput.value.trim()
                };
                if(config.host && config.clientId && config.clientSecret) {
                    localStorage.setItem('yeastarConfig', JSON.stringify(config));
                    alert('Configuration saved to your browser\'s local storage.');
                } else {
                    alert('Please fill all fields before saving.');
                }
            });
        });
    </script>
</body>
</html>
